generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Users
// ============================================
model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  passwordHash    String   @db.VarChar(255)
  displayName     String   @db.VarChar(100)
  primaryCurrency String   @default("USD") @db.Char(3)
  darkMode        Boolean  @default(false)
  locale          String   @default("es") @db.VarChar(10)
  createdAt       DateTime @default(now()) @db.Timestamptz
  updatedAt       DateTime @updatedAt @db.Timestamptz

  transactions          Transaction[]
  categories            Category[]
  savingsGoals          SavingsGoal[]
  recurringTransactions RecurringTransaction[]
  refreshTokens         RefreshToken[]
  accounts              Account[]

  @@index([email])
  @@map("users")
}

// ============================================
// Accounts (Multi-currency balances)
// ============================================
model Account {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  name      String   @db.VarChar(100)
  currency  String   @db.Char(3)
  icon      String?  @db.VarChar(50)
  color     String   @default("#00B9AE") @db.Char(7)
  isDefault Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  savingsGoalsAsDefault SavingsGoal[]
  savingsDeposits       SavingsDeposit[]

  @@unique([userId, name])
  @@index([userId])
  @@index([userId, isDefault])
  @@map("accounts")
}

// ============================================
// Refresh Tokens
// ============================================
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @db.Timestamptz
  createdAt DateTime @default(now()) @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// Categories
// ============================================
model Category {
  id        String       @id @default(uuid()) @db.Uuid
  userId    String       @db.Uuid
  name      String       @db.VarChar(50)
  icon      String       @db.VarChar(50)
  color     String       @db.Char(7)
  type      CategoryType
  isDefault Boolean      @default(false)
  keywords  String[]     @db.Text
  createdAt DateTime     @default(now()) @db.Timestamptz

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name])
  @@index([userId])
  @@map("categories")
}

// ============================================
// Transactions
// ============================================
model Transaction {
  id          String          @id @default(uuid()) @db.Uuid
  userId      String          @db.Uuid
  accountId   String?         @db.Uuid
  amount      Decimal         @db.Decimal(15, 2)
  currency    String          @db.Char(3)
  categoryId  String          @db.Uuid
  type        TransactionType @default(EXPENSE)
  description String?         @db.Text
  date        DateTime        @db.Timestamptz
  receiptUrl  String?         @db.Text
  isRecurring Boolean         @default(false)
  recurringId String?         @db.Uuid
  createdAt   DateTime        @default(now()) @db.Timestamptz
  updatedAt   DateTime        @updatedAt @db.Timestamptz
  deletedAt   DateTime?       @db.Timestamptz

  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  account   Account?              @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category  Category              @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  recurring RecurringTransaction? @relation(fields: [recurringId], references: [id])

  @@index([userId, date])
  @@index([accountId])
  @@index([categoryId])
  @@index([deletedAt])
  @@index([userId, type])
  @@map("transactions")
}

// ============================================
// Recurring Transactions
// ============================================
model RecurringTransaction {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @db.Uuid
  amount        Decimal   @db.Decimal(15, 2)
  currency      String    @db.Char(3)
  categoryId    String    @db.Uuid
  description   String?   @db.Text
  frequency     Frequency
  nextExecution DateTime  @db.Timestamptz
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now()) @db.Timestamptz
  updatedAt     DateTime  @updatedAt @db.Timestamptz

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, nextExecution])
  @@index([isActive])
  @@map("recurring_transactions")
}

// ============================================
// Savings Goals
// ============================================
model SavingsGoal {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @db.Uuid
  name              String    @db.VarChar(100)
  targetAmount      Decimal   @db.Decimal(15, 2)
  currentAmount     Decimal   @default(0) @db.Decimal(15, 2)
  currency          String    @db.Char(3)
  deadline          DateTime? @db.Timestamptz
  deductFromBalance Boolean   @default(true)
  defaultAccountId  String?   @db.Uuid
  createdAt         DateTime  @default(now()) @db.Timestamptz
  updatedAt         DateTime  @updatedAt @db.Timestamptz

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  defaultAccount Account?         @relation(fields: [defaultAccountId], references: [id], onDelete: SetNull)
  deposits       SavingsDeposit[]

  @@index([userId])
  @@index([defaultAccountId])
  @@map("savings_goals")
}

model SavingsDeposit {
  id            String   @id @default(uuid()) @db.Uuid
  savingsGoalId String   @db.Uuid
  accountId     String?  @db.Uuid
  amount        Decimal  @db.Decimal(15, 2)
  currency      String   @db.Char(3)
  note          String?  @db.Text
  date          DateTime @default(now()) @db.Timestamptz
  createdAt     DateTime @default(now()) @db.Timestamptz

  savingsGoal SavingsGoal @relation(fields: [savingsGoalId], references: [id], onDelete: Cascade)
  account     Account?    @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([savingsGoalId])
  @@index([accountId])
  @@map("savings_deposits")
}

// ============================================
// Enums
// ============================================
enum TransactionType {
  EXPENSE
  INCOME
  TRANSFER_TO_SAVINGS

  @@map("transaction_type")
}

enum CategoryType {
  EXPENSE
  INCOME

  @@map("category_type")
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY

  @@map("frequency")
}
